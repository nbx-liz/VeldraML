# AGENTS.md

## 目的
このリポジトリは、LightGBMベースの分析ライブラリ（回帰・二値分類・多値分類・フロンティア）を
**Config駆動**で学習・評価・最適化・配布・シミュレーションまで一気通貫に扱えるようにする。

AIエージェントは、実装・設計・テスト・ドキュメント更新を支援し、作業の履歴と意思決定を明確に残す。

---

## 最優先の設計原則（破ってはいけない）
1. **CoreはGUI/CLI/APIを知らない**（Coreは純Pythonライブラリ。外側はアダプタ）
2. **唯一の共通入口はRunConfig**（GUI/CLI/APIは同じConfigで動く）
3. **Artifactが受け渡しの単位**（再現性・推論・シミュレーションに必要なものを同梱）
4. **Stable APIを壊さない**（`veldra.api` 配下の公開APIは互換性優先）
5. **再現性優先**（seed / split / params / versions / data schema を保存）
6. **仕様未確定は仮実装しない**（未確定は「提案→決定→実装」の順で、HISTORYに残す）
7. **Python環境はuvで管理する**

---

## エージェントの作業フロー（必須）
### 0) 作業開始前
- `DESIGN_BLUEPRINT.md` を読む（現状の前提・構造・未決事項を把握）
- `HISTORY.md` の最新セクションを読む（直近の変更・決定事項）
- 作業対象の「スコープ」と「完了条件」を明確化してから着手する

### 1) 実装前に必ず残すもの
- 変更が設計に関わる場合：
  - `DESIGN_BLUEPRINT.md` の該当セクションに「提案内容」と「理由」を追記
  - `HISTORY.md` に「Decision（暫定/確定）」を記録

### 2) 実装中の基本ルール
- 小さく分割してコミット（1コミット=1論点が理想）
- 仕様の空白は `TODO:` と `OPEN QUESTION:` で明示し、HISTORYに残す
- “動くけど危険” を残さない（例：校正のデータリーク、CVの誤用、分布外無警告など）

### 3) 実装後の必須チェック
- 変更に対応するテストを追加/更新（ユニット or 最低限のスモーク）
- `ruff/pytest` 等の基本チェックを通す（導入している場合）
- Artifact互換性に影響がある場合：manifestのversion/移行方針を更新

---

## 期待する成果物（タスク別）
### コード
- Core（`src/veldra/`）は機能単位で追加
- 外側（CLI/GUI/API）はCoreの呼び出しに徹し、ロジックを持たない

### テスト
- “壊れやすい場所”を優先：
  - RunConfigのバリデーション
  - Splitter（特に時系列）
  - Binaryの確率校正（OOFのみでfitされること）
  - Artifactのsave/load（同一結果の再現）
  - Scenario DSL（制約違反時の挙動）

### ドキュメント
- 設計変更があれば `DESIGN_BLUEPRINT.md` を更新
- 作業履歴と意思決定は `HISTORY.md` に必ず残す

---

## コーディング規約（最低限）
- 公開APIは `veldra.api.*` に集約し、内部実装は分離する
- 型ヒント必須（公開APIは特に厳密に）
- 例外は `veldra.api.exceptions` 経由で統一（ユーザーに意味が伝わるメッセージ）
- ログは構造化（最低：run_id / artifact_path / task_type を含む）

---

## 仕様の決定プロトコル（AIエージェント向け）
- 仕様が曖昧な場合は「候補A/B」と「比較軸」を提示
- 推奨案を1つ決め、理由（安全性/再現性/運用性/実装コスト）を簡潔に書く
- 仮決定は `HISTORY.md` に **Decision: provisional** として記録
- 後で確定したら **Decision: confirmed** に更新（取り消し線ではなく追記で）

---

## PR/変更のチェックリスト（エージェント用）
- [ ] 変更の目的が明確（何を解決するか）
- [ ] 互換性（Config/Artifact/Stable API）への影響を評価
- [ ] テスト追加/更新
- [ ] DESIGN_BLUEPRINT更新（設計変更がある場合）
- [ ] HISTORY更新（Decision/Changeの記録）
- [ ] 例外・ログが適切
